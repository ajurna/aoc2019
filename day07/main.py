from typing import Iterable

from intcode import Machine
from itertools import permutations

puzzle_input = [3, 8, 1001, 8, 10, 8, 105, 1, 0, 0, 21, 34, 55, 68, 93, 106, 187, 268, 349, 430, 99999, 3, 9, 102, 5, 9,
                9, 1001, 9, 2, 9, 4, 9, 99, 3, 9, 1001, 9, 5, 9, 102, 2, 9, 9, 101, 2, 9, 9, 102, 2, 9, 9, 4, 9, 99, 3,
                9, 101, 2, 9, 9, 102, 4, 9, 9, 4, 9, 99, 3, 9, 101, 4, 9, 9, 102, 3, 9, 9, 1001, 9, 2, 9, 102, 4, 9, 9,
                1001, 9, 2, 9, 4, 9, 99, 3, 9, 101, 2, 9, 9, 1002, 9, 5, 9, 4, 9, 99, 3, 9, 101, 1, 9, 9, 4, 9, 3, 9,
                1002, 9, 2, 9, 4, 9, 3, 9, 1002, 9, 2, 9, 4, 9, 3, 9, 1002, 9, 2, 9, 4, 9, 3, 9, 101, 2, 9, 9, 4, 9, 3,
                9, 1001, 9, 2, 9, 4, 9, 3, 9, 1002, 9, 2, 9, 4, 9, 3, 9, 102, 2, 9, 9, 4, 9, 3, 9, 1002, 9, 2, 9, 4, 9,
                3, 9, 101, 1, 9, 9, 4, 9, 99, 3, 9, 101, 2, 9, 9, 4, 9, 3, 9, 1001, 9, 1, 9, 4, 9, 3, 9, 101, 1, 9, 9,
                4, 9, 3, 9, 1001, 9, 1, 9, 4, 9, 3, 9, 1001, 9, 2, 9, 4, 9, 3, 9, 102, 2, 9, 9, 4, 9, 3, 9, 1001, 9, 1,
                9, 4, 9, 3, 9, 102, 2, 9, 9, 4, 9, 3, 9, 1001, 9, 1, 9, 4, 9, 3, 9, 101, 2, 9, 9, 4, 9, 99, 3, 9, 102,
                2, 9, 9, 4, 9, 3, 9, 102, 2, 9, 9, 4, 9, 3, 9, 1002, 9, 2, 9, 4, 9, 3, 9, 1002, 9, 2, 9, 4, 9, 3, 9,
                1002, 9, 2, 9, 4, 9, 3, 9, 101, 1, 9, 9, 4, 9, 3, 9, 101, 1, 9, 9, 4, 9, 3, 9, 101, 1, 9, 9, 4, 9, 3, 9,
                101, 2, 9, 9, 4, 9, 3, 9, 1001, 9, 2, 9, 4, 9, 99, 3, 9, 1002, 9, 2, 9, 4, 9, 3, 9, 1002, 9, 2, 9, 4, 9,
                3, 9, 1001, 9, 2, 9, 4, 9, 3, 9, 1002, 9, 2, 9, 4, 9, 3, 9, 1002, 9, 2, 9, 4, 9, 3, 9, 101, 2, 9, 9, 4,
                9, 3, 9, 1001, 9, 2, 9, 4, 9, 3, 9, 101, 1, 9, 9, 4, 9, 3, 9, 101, 1, 9, 9, 4, 9, 3, 9, 101, 1, 9, 9, 4,
                9, 99, 3, 9, 101, 2, 9, 9, 4, 9, 3, 9, 1002, 9, 2, 9, 4, 9, 3, 9, 1002, 9, 2, 9, 4, 9, 3, 9, 101, 1, 9,
                9, 4, 9, 3, 9, 1001, 9, 1, 9, 4, 9, 3, 9, 101, 2, 9, 9, 4, 9, 3, 9, 1002, 9, 2, 9, 4, 9, 3, 9, 1002, 9,
                2, 9, 4, 9, 3, 9, 1002, 9, 2, 9, 4, 9, 3, 9, 1002, 9, 2, 9, 4, 9, 99]

signals = set()
for perms in permutations([0, 1, 2, 3, 4], 5):
    signal = 0
    for perm in perms:
        machine = Machine(puzzle_input.copy(), [perm, signal])
        machine.run()
        signal = machine.output[-1]
    signals.add(signal)
print(f"Part 1: {max(signals)}")

signals = set()
for perms in permutations([5, 6, 7, 8, 9], 5):
    perms: Iterable
    signal = 0
    machine_list = [Machine(puzzle_input.copy(), [x], interactive_mode=False) for x in perms]
    while machine_list[-1].code[machine_list[-1].instruction_pointer] != 99:
        for machine in machine_list:
            machine.provided_input.append(signal)
            machine.run()
            signal = machine.output.pop(0)
    signals.add(signal)
print(f"Part 2: {max(signals)}")
